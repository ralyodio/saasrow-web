/*
  # Fix Critical RLS Vulnerability on software_submissions

  ## Problem
  The UPDATE policy on software_submissions has USING(true) and WITH CHECK(true),
  allowing ANYONE to update ANY submission with ANY values, including:
  - tier (free/featured/premium)
  - status (pending/approved/rejected)
  - featured flags
  - All metadata
  
  This is a catastrophic security breach.

  ## Solution
  1. Drop the insecure policy
  2. Create a restrictive policy that:
     - Only allows updates via edge functions (service role)
     - Removes direct update capability from anon users
  3. All updates must go through edge functions which validate tokens

  ## Security Impact
  After this migration:
  - Anonymous users CANNOT directly update submissions
  - All updates must go through /functions/v1/submissions with valid token
  - Edge function validates management_token before allowing updates
*/

-- Drop the dangerous policy
DROP POLICY IF EXISTS "Users can update own submissions with token" ON software_submissions;

-- No replacement policy needed - updates will only work through edge functions
-- which use service_role_key and validate tokens properly

-- For transparency: Add a comment to the table
COMMENT ON TABLE software_submissions IS 'Updates restricted to edge functions only. Users must use /functions/v1/submissions with valid management_token.';
